<div class="max-w-7xl mx-auto animate-fade-in">
  <div class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
    <div>
      <h1 class="text-3xl font-black text-white tracking-tight flex items-center gap-3">
        <span class="bg-indigo-500 w-1.5 h-8 rounded-full inline-block"></span>
        ระบบการเงิน & COD
      </h1>
      <p class="text-slate-400 mt-2 ml-6 text-sm">จัดการยอดเก็บเงินปลายทางและการโอนคืนลูกค้า</p>
    </div>
    <div class="glass-panel-dark rounded-full p-1.5 flex shadow-2xl border border-white/5 bg-slate-900/50">
      <a href="/cod?tab=collection"
        class="px-6 py-2.5 rounded-full text-sm font-bold transition-all flex items-center gap-2 <%= tab === 'collection' ? 'bg-amber-500 text-white shadow-lg shadow-amber-900/20' : 'text-slate-400 hover:bg-white/5 hover:text-white' %>">
        <i class="fa-solid fa-hand-holding-dollar"></i> รอเก็บเงิน
      </a>
      <a href="/cod?tab=remittance"
        class="px-6 py-2.5 rounded-full text-sm font-bold transition-all flex items-center gap-2 <%= tab === 'remittance' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/20' : 'text-slate-400 hover:bg-white/5 hover:text-white' %>">
        <i class="fa-solid fa-money-bill-transfer"></i> รอโอนคืน
      </a>
    </div>
  </div>

  <% if (error) { %>
    <div
      class="mb-6 p-4 rounded-xl bg-red-500/10 text-red-200 border border-red-500/20 flex items-center gap-3 animate-pulse-once">
      <i class="fa-solid fa-circle-exclamation text-xl"></i>
      <%= error %>
    </div>
    <% } %>

      <div
        class="glass-panel-dark card-elevated rounded-3xl overflow-hidden shadow-2xl border border-white/5 animate-fade-in-up">
        <div class="p-6 border-b border-white/5 bg-black/20">
          <h3 class="font-bold text-white flex items-center gap-2">
            <% if(tab==='collection' ) { %>
              <span
                class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center text-amber-500 border border-amber-500/20 shadow-inner">
                <i class="fa-solid fa-truck-fast"></i>
              </span>
              รายการรอเก็บเงินจากคนขับ
              <% } else { %>
                <span
                  class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400 border border-indigo-500/20 shadow-inner">
                  <i class="fa-solid fa-building-columns"></i>
                </span>
                รายการรอโอนเงินคืนร้านค้า
                <% } %>
          </h3>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm table-premium text-left">
            <thead class="text-xs text-slate-400 uppercase bg-black/20 border-b border-white/5">
              <tr>
                <th class="px-6 py-4 font-bold tracking-wider">Job No</th>
                <th class="px-6 py-4 font-bold tracking-wider">Sender</th>
                <th class="px-6 py-4 font-bold tracking-wider">Receiver</th>
                <th class="px-6 py-4 font-bold tracking-wider text-right">COD Amount</th>
                <th class="px-6 py-4 font-bold tracking-wider text-center">Status</th>
                <th class="px-6 py-4 font-bold tracking-wider text-right">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-white/5 text-slate-300">
              <% if (items.length===0) { %>
                <tr>
                  <td colspan="6" class="px-6 py-16 text-center text-slate-500">
                    <div class="flex flex-col items-center justify-center">
                      <i class="fa-solid fa-folder-open text-5xl mb-4 opacity-20"></i>
                      <p class="font-medium">ไม่พบรายการที่ต้องดำเนินการ</p>
                      <p class="text-xs mt-1 opacity-60">ทุกรายการเคลียร์หมดแล้ว</p>
                    </div>
                  </td>
                </tr>
                <% } %>
                  <% items.forEach(o=> { %>
                    <tr class="hover:bg-white/5 transition-colors group">
                      <td class="px-6 py-4">
                        <div class="font-mono font-bold text-white group-hover:text-amber-400 transition-colors">
                          <%= o.job_no %>
                        </div>
                        <div
                          class="text-[10px] px-2 py-0.5 rounded bg-slate-800 text-slate-400 inline-block mt-1 border border-slate-700 font-bold uppercase tracking-wider">
                          <%= o.direction %>
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="font-bold text-slate-200">
                          <%= o.sender_name || '-' %>
                        </div>
                        <div class="text-xs text-slate-500 font-mono mt-0.5">
                          <%= o.sender_phone || '' %>
                        </div>
                      </td>
                      <td class="px-6 py-4">
                        <div class="font-bold text-slate-200">
                          <%= o.receiver_name || '-' %>
                        </div>
                        <div class="text-xs text-slate-500 font-mono mt-0.5">
                          <%= o.receiver_phone || '' %>
                        </div>
                      </td>
                      <td class="px-6 py-4 text-right">
                        <div class="font-black text-emerald-400 font-mono text-lg">฿<%=
                            Number(o.cod_amount).toLocaleString() %>
                        </div>
                      </td>
                      <td class="px-6 py-4 text-center">
                        <span
                          class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold tracking-wide border uppercase <%= o.cod_status === 'COLLECTED' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-amber-500/10 text-amber-400 border-amber-500/20' %>">
                          <span
                            class="w-1.5 h-1.5 rounded-full mr-1.5 <%= o.cod_status === 'COLLECTED' ? 'bg-emerald-400' : 'bg-amber-400' %>"></span>
                          <%= o.cod_status || 'PENDING' %>
                        </span>
                      </td>
                      <td class="px-6 py-4 text-right">
                        <% if(tab==='collection' ) { %>
                          <form method="post" action="/cod/<%= o.id %>/collect">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <button
                              class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg shadow-emerald-900/20 transition-all flex items-center gap-2 ml-auto hover:-translate-y-0.5 active:scale-95">
                              <i class="fa-solid fa-check"></i> รับเงินแล้ว
                            </button>
                          </form>
                          <% } else { %>
                            <button
                              onclick="openRemitModal('<%= o.id %>', '<%= o.cod_amount %>', '<%= o.sender_name %>')"
                              class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg shadow-indigo-900/20 transition-all flex items-center gap-2 ml-auto hover:-translate-y-0.5 active:scale-95">
                              <i class="fa-solid fa-money-bill-transfer"></i> โอนคืน
                            </button>
                            <% } %>
                      </td>
                    </tr>
                    <% }) %>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Remittance Modal -->
      <div id="remitModal"
        class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
        <div
          class="glass-panel-dark rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-white/10 ring-1 ring-white/5">
          <div class="p-6 border-b border-white/5 bg-black/40">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
              <i class="fa-solid fa-circle-check text-indigo-500"></i> ยืนยันการโอนเงิน
            </h3>
          </div>
          <form id="remitForm" method="post" action="" class="p-6 space-y-5">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <div>
              <label
                class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ยอดเงินที่ต้องโอน</label>
              <div class="text-3xl font-black text-emerald-400 font-mono tracking-tight" id="modalAmount">BTC 0.00
              </div>
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">โอนคืนให้กับ</label>
              <input type="text" id="modalCustomer" readonly
                class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 text-slate-300 font-bold">
            </div>
            <div>
              <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">หลักฐานการโอน /
                หมายเหตุ</label>
              <input type="text" name="remitted_to" placeholder="ธนาคาร กสิกร xxx-x-xxxxx, เวลา..."
                class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:ring-indigo-500 focus:border-indigo-500 placeholder-slate-600 transition-colors">
            </div>
            <div class="flex items-center gap-3 pt-4">
              <button type="button" onclick="closeRemitModal()"
                class="flex-1 px-4 py-3 bg-slate-800 text-slate-300 rounded-xl hover:bg-slate-700 font-bold transition-all border border-slate-700">ยกเลิก</button>
              <button type="submit"
                class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 font-bold shadow-lg shadow-indigo-900/40 transition-all hover:translate-y-[-2px]">ยืนยันโอนแล้ว</button>
            </div>
          </form>
        </div>
      </div>

      <script>
        function openRemitModal(id, amount, customer) {
          document.getElementById('remitForm').action = '/cod/' + id + '/remit';
          document.getElementById('modalAmount').textContent = '฿' + Number(amount).toLocaleString();
          document.getElementById('modalCustomer').value = customer || 'ไม่ระบุ';
          document.getElementById('remitModal').classList.remove('hidden');
        }
        function closeRemitModal() {
          document.getElementById('remitModal').classList.add('hidden');
        }
      </script>
</div>