<!-- Dashboard Content -->
<div class="space-y-6">

  <!-- Page Header -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h2 class="text-3xl md:text-4xl font-bold text-white">
        ภาพรวม<span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">วันนี้</span>
      </h2>
      <p class="text-slate-400 text-sm mt-1">
        <i class="fa-regular fa-calendar mr-1"></i>
        <%= new Date().toLocaleDateString('th-TH', { weekday: 'long' , year: 'numeric' , month: 'long' , day: 'numeric'
          }) %>
      </p>
    </div>
    <div class="flex gap-3">
      <a href="/scanner"
        class="flex items-center gap-2 px-4 py-2.5 bg-white/5 border border-white/10 text-white rounded-xl hover:bg-white/10 transition-all">
        <i class="fa-solid fa-qrcode"></i>
        <span class="hidden sm:inline">สแกนพัสดุ</span>
      </a>
      <a href="/orders/new"
        class="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-xl hover:shadow-lg hover:shadow-cyan-500/30 transition-all">
        <i class="fa-solid fa-plus"></i>
        <span class="hidden sm:inline">สร้างออเดอร์</span>
      </a>
    </div>
  </div>

  <!-- KPI Cards - 5 Cards -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">

    <!-- Card 1: ออเดอร์วันนี้ -->
    <div class="kpi-card-premium blue">
      <div class="flex items-center justify-between mb-4">
        <div class="kpi-icon bg-blue-500/20">
          <i class="fa-solid fa-box text-blue-400"></i>
        </div>
        <div class="text-xs text-blue-400 bg-blue-500/10 px-2 py-1 rounded-full">
          +12%
        </div>
      </div>
      <p class="kpi-label mb-1">ออเดอร์วันนี้</p>
      <h3 class="kpi-value">
        <%= kpi.todayOrders || 0 %>
      </h3>
    </div>

    <!-- Card 2: กำลังขนส่ง -->
    <div class="kpi-card-premium orange">
      <div class="flex items-center justify-between mb-4">
        <div class="kpi-icon bg-orange-500/20">
          <i class="fa-solid fa-truck-fast text-orange-400"></i>
        </div>
        <div class="relative flex h-3 w-3">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-orange-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3 w-3 bg-orange-500"></span>
        </div>
      </div>
      <p class="kpi-label mb-1">กำลังขนส่ง</p>
      <h3 class="kpi-value">
        <%= kpi.inTransit || 0 %>
      </h3>
    </div>

    <!-- Card 3: ถึงปลายทาง -->
    <div class="kpi-card-premium green">
      <div class="flex items-center justify-between mb-4">
        <div class="kpi-icon bg-green-500/20">
          <i class="fa-solid fa-circle-check text-green-400"></i>
        </div>
        <i class="fa-solid fa-check text-green-400 text-sm"></i>
      </div>
      <p class="kpi-label mb-1">ถึงปลายทาง</p>
      <h3 class="kpi-value">
        <%= kpi.delivered || 0 %>
      </h3>
    </div>

    <!-- Card 4: รายได้วันนี้ -->
    <div class="kpi-card-premium purple">
      <div class="flex items-center justify-between mb-4">
        <div class="kpi-icon bg-purple-500/20">
          <i class="fa-solid fa-coins text-purple-400"></i>
        </div>
        <i class="fa-solid fa-baht-sign text-purple-400/50"></i>
      </div>
      <p class="kpi-label mb-1">รายได้วันนี้</p>
      <h3 class="kpi-value text-2xl">฿<%= Number(kpi.todayRevenue || 0).toLocaleString() %>
      </h3>
    </div>

    <!-- Card 5: กำไร -->
    <div class="kpi-card-premium emerald col-span-2 md:col-span-1">
      <div class="flex items-center justify-between mb-4">
        <div class="kpi-icon bg-emerald-500/20">
          <i class="fa-solid fa-chart-line text-emerald-400"></i>
        </div>
        <div class="text-xs text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded-full">
          <i class="fa-solid fa-arrow-up mr-1"></i>กำไร
        </div>
      </div>
      <p class="kpi-label mb-1">กำไรวันนี้</p>
      <h3 class="kpi-value text-2xl text-emerald-400">฿<%= Number(kpi.todayProfit || 0).toLocaleString() %>
      </h3>
    </div>
  </div>

  <!-- Status Quick Filters -->
  <div class="glass-panel-dark p-4">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-white font-semibold flex items-center gap-2">
        <i class="fa-solid fa-filter text-cyan-400"></i>
        กรองตามสถานะ
      </h3>
      <button class="text-xs text-slate-400 hover:text-white transition-colors" onclick="clearFilters()">
        <i class="fa-solid fa-rotate-left mr-1"></i> รีเซ็ต
      </button>
    </div>
    <div class="flex flex-wrap gap-2">
      <button class="status-pill new" data-status="new">
        <i class="fa-solid fa-circle-dot"></i> ใหม่
      </button>
      <button class="status-pill received" data-status="received">
        <i class="fa-solid fa-box-open"></i> รับของ
      </button>
      <button class="status-pill crossing" data-status="crossing">
        <i class="fa-solid fa-globe"></i> ข้ามแดน
      </button>
      <button class="status-pill warehouse" data-status="warehouse">
        <i class="fa-solid fa-warehouse"></i> ถึงคลัง
      </button>
      <button class="status-pill delivery" data-status="delivery">
        <i class="fa-solid fa-truck"></i> ออกส่ง
      </button>
      <button class="status-pill completed" data-status="completed">
        <i class="fa-solid fa-check-circle"></i> สำเร็จ
      </button>
    </div>
  </div>

  <!-- Chart and Recent Orders Grid -->
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

    <!-- Chart Section -->
    <div class="xl:col-span-2 glass-panel-dark p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-white font-semibold flex items-center gap-2">
          <i class="fa-solid fa-chart-bar text-cyan-400"></i>
          สถิติการจัดส่ง
        </h3>
        <select class="bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-sm text-white">
          <option>30 วันล่าสุด</option>
          <option>7 วันล่าสุด</option>
          <option>เดือนนี้</option>
        </select>
      </div>
      <div class="h-64 md:h-80">
        <canvas id="ordersChart"></canvas>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="glass-panel-dark p-6">
      <h3 class="text-white font-semibold flex items-center gap-2 mb-6">
        <i class="fa-solid fa-bolt text-amber-400"></i>
        สรุปด่วน
      </h3>
      <div class="space-y-4">
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
          <span class="text-slate-400 text-sm">ออเดอร์ทั้งหมด</span>
          <span class="text-white font-bold">
            <%= kpi.totalOrders || 0 %>
          </span>
        </div>
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
          <span class="text-slate-400 text-sm">รายได้เดือนนี้</span>
          <span class="text-purple-400 font-bold">฿<%= Number(kpi.monthlyRevenue || 0).toLocaleString() %></span>
        </div>
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
          <span class="text-slate-400 text-sm">ลูกค้าทั้งหมด</span>
          <span class="text-cyan-400 font-bold">
            <%= kpi.totalCustomers || 0 %>
          </span>
        </div>
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
          <span class="text-slate-400 text-sm">อัตราความสำเร็จ</span>
          <span class="text-green-400 font-bold">98.5%</span>
        </div>
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl">
          <span class="text-slate-400 text-sm">COD รอเก็บ</span>
          <span class="text-amber-400 font-bold">฿<%= Number(kpi.pendingCOD || 0).toLocaleString() %></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Orders Table -->
  <div class="glass-panel-dark overflow-hidden">
    <div class="flex items-center justify-between p-6 border-b border-white/5">
      <h3 class="text-white font-semibold flex items-center gap-2">
        <i class="fa-solid fa-clock-rotate-left text-cyan-400"></i>
        ออเดอร์ล่าสุด
      </h3>
      <a href="/orders" class="text-sm text-cyan-400 hover:text-cyan-300 transition-colors">
        ดูทั้งหมด <i class="fa-solid fa-arrow-right ml-1"></i>
      </a>
    </div>

    <div class="overflow-x-auto">
      <table class="table-premium">
        <thead>
          <tr>
            <th>เลขพัสดุ</th>
            <th>ผู้ส่ง</th>
            <th>ผู้รับ</th>
            <th>สถานะ</th>
            <th>COD</th>
            <th class="text-right">จัดการ</th>
          </tr>
        </thead>
        <tbody>
          <% if (latest && latest.length> 0) { %>
            <% latest.forEach(order=> { %>
              <tr>
                <td>
                  <div class="flex items-center gap-3">
                    <div
                      class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-600/20 border border-cyan-500/30 flex items-center justify-center">
                      <span class="text-cyan-400 font-bold text-xs">
                        <%= order.job_no.slice(-3) %>
                      </span>
                    </div>
                    <div>
                      <div class="font-mono text-white font-semibold text-sm">
                        <%= order.job_no %>
                      </div>
                      <div class="text-xs text-slate-500">
                        <%= order.direction==='TH_TO_LA' ? 'ไทย → ลาว' : 'ลาว → ไทย' %>
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="text-white text-sm">
                    <%= order.sender_name || '-' %>
                  </div>
                  <div class="text-xs text-slate-500">
                    <%= order.sender_phone || '' %>
                  </div>
                </td>
                <td>
                  <div class="text-white text-sm">
                    <%= order.receiver_name || '-' %>
                  </div>
                  <div class="text-xs text-slate-500">
                    <%= order.receiver_phone || '' %>
                  </div>
                </td>
                <td>
                  <% let statusClass='new' ; let statusText='ใหม่' ; let statusIcon='circle-dot' ; if
                    (order.status==='RECEIVED' || order.status==='RECEIVED_WH_TH' || order.status==='RECEIVED_WH_LA' ) {
                    statusClass='received' ; statusText='รับของ' ; statusIcon='box-open' ; } else if
                    (order.status==='CROSSING_BORDER' || order.status==='ON_TRUCK_BORDER' ) { statusClass='crossing' ;
                    statusText='ข้ามแดน' ; statusIcon='globe' ; } else if (order.status==='AT_DEST_WH' ||
                    order.status==='ARRIVED_BORDER_WH' ) { statusClass='warehouse' ; statusText='ถึงคลัง' ;
                    statusIcon='warehouse' ; } else if (order.status==='OUT_FOR_DELIVERY' || order.status==='DEPARTED' )
                    { statusClass='delivery' ; statusText='ออกส่ง' ; statusIcon='truck' ; } else if
                    (order.status==='DELIVERED' || order.status==='CLOSED' ) { statusClass='completed' ;
                    statusText='สำเร็จ' ; statusIcon='check-circle' ; } %>
                    <span class="status-pill <%= statusClass %>">
                      <i class="fa-solid fa-<%= statusIcon %>"></i>
                      <%= statusText %>
                    </span>
                </td>
                <td>
                  <% if (order.cod_amount && order.cod_amount> 0) { %>
                    <span class="text-amber-400 font-semibold">฿<%= Number(order.cod_amount).toLocaleString() %></span>
                    <% } else { %>
                      <span class="text-slate-500">-</span>
                      <% } %>
                </td>
                <td class="text-right">
                  <a href="/orders/<%= order.id %>"
                    class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-white/5 hover:bg-cyan-500/20 text-slate-400 hover:text-cyan-400 transition-all">
                    <i class="fa-solid fa-eye"></i>
                  </a>
                </td>
              </tr>
              <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="6" class="text-center py-12">
                      <div class="text-slate-500">
                        <i class="fa-solid fa-inbox text-4xl mb-4 block"></i>
                        <p>ยังไม่มีออเดอร์</p>
                      </div>
                    </td>
                  </tr>
                  <% } %>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Chart.js Script -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('ordersChart');
    if (!ctx) return;

    const chartData = <% - JSON.stringify(chartData || { labels: [], orders: [], revenue: [] }) %>;

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartData.labels || [],
        datasets: [
          {
            label: 'จำนวนออเดอร์',
            data: chartData.orders || [],
            backgroundColor: 'rgba(6, 182, 212, 0.5)',
            borderColor: 'rgba(6, 182, 212, 1)',
            borderWidth: 1,
            borderRadius: 6,
            yAxisID: 'y'
          },
          {
            label: 'รายได้ (บาท)',
            data: chartData.revenue || [],
            type: 'line',
            borderColor: 'rgba(168, 85, 247, 1)',
            backgroundColor: 'rgba(168, 85, 247, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: 'rgba(168, 85, 247, 1)',
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              color: '#e2e8f0',
              padding: 20,
              font: { size: 12, weight: '500' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: '#06b6d4',
            bodyColor: '#e2e8f0',
            borderColor: 'rgba(255,255,255,0.1)',
            borderWidth: 1,
            padding: 12,
            callbacks: {
              label: function (context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                if (context.datasetIndex === 1) {
                  label += '฿' + context.parsed.y.toLocaleString('th-TH');
                } else {
                  label += context.parsed.y;
                }
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#64748b' }
          },
          y: {
            position: 'left',
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: '#06b6d4' },
            title: { display: true, text: 'ออเดอร์', color: '#06b6d4' }
          },
          y1: {
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: {
              color: '#a855f7',
              callback: function (value) { return '฿' + value.toLocaleString(); }
            },
            title: { display: true, text: 'รายได้', color: '#a855f7' }
          }
        }
      }
    });
  });

  function clearFilters() {
    document.querySelectorAll('.status-pill').forEach(btn => {
      btn.classList.remove('active');
    });
  }
</script>