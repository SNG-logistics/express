<div class="min-h-screen p-4 md:p-6 lg:p-8 relative overflow-hidden">
  <!-- Dynamic Gradient Background -->
  <div class="fixed inset-0 pointer-events-none">
    <div class="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-black"></div>
    <div class="absolute top-0 left-0 w-full h-full opacity-30">
      <div class="absolute top-[-10%] left-[-5%] w-[40%] h-[40%] bg-blue-500/20 rounded-full blur-[120px]"></div>
      <div class="absolute bottom-[-10%] right-[-5%] w-[40%] h-[40%] bg-purple-500/20 rounded-full blur-[120px]"></div>
    </div>
  </div>

  <div class="relative z-10 max-w-[1600px] mx-auto space-y-6">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-6 border-b border-white/10">
      <div>
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
          แดชบอร์ด <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">SNG</span>
        </h1>
        <p class="text-slate-400">ระบบขนส่งไทย-ลาว | อัพเดทแบบเรียลไทม์</p>
      </div>
      <div class="flex gap-3">
        <a href="/orders/new"
          class="btn-large bg-gradient-to-r from-cyan-500 to-blue-600 text-white px-6 py-3 rounded-xl hover:shadow-lg hover:shadow-cyan-500/50">
          <i class="fa-solid fa-plus mr-2"></i> สร้างออเดอร์
        </a>
        <a href="/orders/scan"
          class="btn-large bg-white/10 text-white px-6 py-3 rounded-xl border border-white/20 hover:bg-white/20">
          <i class="fa-solid fa-qrcode mr-2"></i> สแกน
        </a>
      </div>
    </div>

    <!-- KPI CARDS - 5 Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
      <!-- Card 1: ออเดอร์วันนี้ -->
      <div class="kpi-card">
        <div class="flex items-start justify-between mb-4">
          <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
            <i class="fa-solid fa-box text-blue-400 text-xl"></i>
          </div>
        </div>
        <p class="kpi-label mb-2">ออเดอร์วันนี้</p>
        <h3 class="kpi-value">
          <%= kpi.todayOrders || 0 %>
        </h3>
        <p class="text-xs text-slate-500 mt-2">
          <i class="fa-solid fa-calendar mr-1"></i>
          <%= new Date().toLocaleDateString('th-TH') %>
        </p>
      </div>

      <!-- Card 2: กำลังขนส่ง -->
      <div class="kpi-card">
        <div class="flex items-start justify-between mb-4">
          <div class="w-12 h-12 rounded-xl bg-orange-500/20 flex items-center justify-center">
            <i class="fa-solid fa-truck-fast text-orange-400 text-xl"></i>
          </div>
        </div>
        <p class="kpi-label mb-2">กำลังขนส่ง</p>
        <h3 class="kpi-value">
          <%= kpi.inTransit || 0 %>
        </h3>
        <p class="text-xs text-orange-400 mt-2">
          <i class="fa-solid fa-circle-dot mr-1 animate-pulse"></i> กำลังดำเนินการ
        </p>
      </div>

      <!-- Card 3: ถึงปลายทาง -->
      <div class="kpi-card">
        <div class="flex items-start justify-between mb-4">
          <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
            <i class="fa-solid fa-circle-check text-green-400 text-xl"></i>
          </div>
        </div>
        <p class="kpi-label mb-2">ถึงปลายทาง</p>
        <h3 class="kpi-value">
          <%= kpi.delivered || 0 %>
        </h3>
        <p class="text-xs text-green-400 mt-2">
          <i class="fa-solid fa-check mr-1"></i> สำเร็จแล้ว
        </p>
      </div>

      <!-- Card 4: รายได้วันนี้ -->
      <div class="kpi-card">
        <div class="flex items-start justify-between mb-4">
          <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center">
            <i class="fa-solid fa-coins text-purple-400 text-xl"></i>
          </div>
        </div>
        <p class="kpi-label mb-2">รายได้วันนี้</p>
        <h3 class="kpi-value text-2xl lg:text-3xl">฿<%= Number(kpi.todayRevenue || 0).toLocaleString() %>
        </h3>
        <p class="text-xs text-slate-500 mt-2">
          <i class="fa-solid fa-arrow-trend-up mr-1"></i> บาท
        </p>
      </div>

      <!-- Card 5: กำไร -->
      <div class="kpi-card">
        <div class="flex items-start justify-between mb-4">
          <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center">
            <i class="fa-solid fa-chart-line text-emerald-400 text-xl"></i>
          </div>
        </div>
        <p class="kpi-label mb-2">กำไร</p>
        <h3 class="kpi-value text-2xl lg:text-3xl text-emerald-400">฿<%= Number(kpi.todayProfit || 0).toLocaleString()
            %>
        </h3>
        <p class="text-xs text-emerald-400 mt-2">
          <i class="fa-solid fa-arrow-up mr-1"></i> บาท
        </p>
      </div>
    </div>

    <!-- FILTER BAR -->
    <div class="filter-group">
      <div class="flex-1 min-w-[250px]">
        <input type="text" id="searchBox" placeholder="ค้นหาเลขพัสดุ, ชื่อลูกค้า..." class="filter-input w-full">
      </div>
      <select id="dateFilter" class="filter-input w-full sm:w-auto">
        <option value="">เลือกวันที่: ทั้งหมด</option>
        <option value="today">วันนี้</option>
        <option value="yesterday">เมื่อวาน</option>
        <option value="week">สัปดาห์นี้</option>
        <option value="month">เดือนนี้</option>
      </select>
      <select id="routeFilter" class="filter-input w-full sm:w-auto">
        <option value="">เส้นทาง: ทั้งหมด</option>
        <option value="เชียงราย-เวียงจันทน์">เชียงราย-เวียงจันทน์</option>
        <option value="กรุงเทพ-หนองคาย">กรุงเทพ-หนองคาย</option>
      </select>
      <select id="statusFilter" class="filter-input w-full sm:w-auto">
        <option value="">สถานะ: ทั้งหมด</option>
        <option value="new">ใหม่</option>
        <option value="received">รับของ</option>
        <option value="crossing">ข้ามแดน</option>
        <option value="warehouse">ถึงคลัง</option>
        <option value="delivery">ออกส่ง</option>
        <option value="completed">สำเร็จ</option>
      </select>
    </div>

    <!-- STATUS FILTER BUTTONS -->
    <div class="glass-panel p-4">
      <h3 class="text-white font-bold text-sm mb-4 flex items-center gap-2">
        <i class="fa-solid fa-filter"></i> กรองตามสถานะรวดเร็ว
      </h3>
      <div class="flex flex-wrap gap-3">
        <button class="status-badge badge-new">
          <i class="fa-solid fa-circle-dot"></i> ใหม่
        </button>
        <button class="status-badge badge-received">
          <i class="fa-solid fa-box-open"></i> รับของ
        </button>
        <button class="status-badge badge-crossing">
          <i class="fa-solid fa-globe"></i> ข้ามแดน
        </button>
        <button class="status-badge badge-warehouse">
          <i class="fa-solid fa-warehouse"></i> ถึงคลัง
        </button>
        <button class="status-badge badge-delivery">
          <i class="fa-solid fa-truck"></i> ออกส่ง
        </button>
        <button class="status-badge badge-completed">
          <i class="fa-solid fa-check-circle"></i> สำเร็จ
        </button>
      </div>
    </div>

    <!-- CHART SECTION -->
    <div class="glass-panel p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-white font-bold text-lg flex items-center gap-2">
          <i class="fa-solid fa-chart-column"></i> สถิติการจัดส่ง
        </h3>
        <select class="filter-input w-auto">
          <option>30 วันล่าสุด</option>
          <option>7 วันล่าสุด</option>
          <option>เดือนนี้</option>
        </select>
      </div>
      <div class="h-64 w-full">
        <canvas id="statsChart"></canvas>
      </div>
    </div>

    <!-- ORDERS TABLE -->
    <div class="glass-panel p-0 overflow-hidden">
      <div
        class="p-6 border-b border-white/10 flex items-center justify-between bg-gradient-to-r from-white/5 to-transparent">
        <h3 class="text-white font-bold text-lg flex items-center gap-2">
          <i class="fa-solid fa-list"></i> รายการออเดอร์ล่าสุด
        </h3>
        <a href="/orders" class="text-sm text-cyan-400 hover:text-cyan-300 flex items-center gap-1">
          ดูทั้งหมด <i class="fa-solid fa-arrow-right text-xs"></i>
        </a>
      </div>

      <div class="overflow-x-auto custom-scrollbar">
        <table class="table-premium w-full">
          <thead>
            <tr>
              <th class="px-6 py-4">เลขพัสดุ</th>
              <th class="px-6 py-4">ผู้ส่ง</th>
              <th class="px-6 py-4">ปลายทาง</th>
              <th class="px-6 py-4">สถานะ</th>
              <th class="px-6 py-4">COD</th>
              <th class="px-6 py-4">วันที่</th>
              <th class="px-6 py-4 text-center">จัดการ</th>
            </tr>
          </thead>
          <tbody>
            <% if (latest && latest.length> 0) { %>
              <% latest.forEach(order=> { %>
                <tr class="hover:bg-white/5 transition-all">
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      <div
                        class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-500/20 flex items-center justify-center border border-cyan-500/30">
                        <span class="text-cyan-400 font-bold text-xs">
                          <%= order.job_no.slice(-3) %>
                        </span>
                      </div>
                      <div>
                        <div class="font-mono text-white font-semibold">
                          <%= order.job_no %>
                        </div>
                        <div class="text-xs text-slate-500">
                          <%= order.route || '-' %>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-slate-200">
                      <%= order.sender_name || '-' %>
                    </div>
                    <div class="text-xs text-slate-500">
                      <%= order.sender_phone || '-' %>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-slate-200">
                      <%= order.receiver_name || '-' %>
                    </div>
                    <div class="text-xs text-slate-500">
                      <%= order.receiver_phone || '-' %>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <% let statusClass='badge-new' ; let statusText='ใหม่' ; let statusIcon='circle-dot' ; if
                      (order.status==='Received' || order.status==='รับของ' ) { statusClass='badge-received' ;
                      statusText='รับของ' ; statusIcon='box-open' ; } else if (order.status==='Crossing' ||
                      order.status==='ข้ามแดน' ) { statusClass='badge-crossing' ; statusText='ข้ามแดน' ;
                      statusIcon='globe' ; } else if (order.status==='Warehouse' || order.status==='ถึงคลัง' ) {
                      statusClass='badge-warehouse' ; statusText='ถึงคลัง' ; statusIcon='warehouse' ; } else if
                      (order.status==='Delivery' || order.status==='ออกส่ง' ) { statusClass='badge-delivery' ;
                      statusText='ออกส่ง' ; statusIcon='truck' ; } else if (order.status==='Delivered' ||
                      order.status==='สำเร็จ' ) { statusClass='badge-completed' ; statusText='สำเร็จ' ;
                      statusIcon='check-circle' ; } %>
                      <span class="status-badge <%= statusClass %>">
                        <i class="fa-solid fa-<%= statusIcon %>"></i>
                        <%= statusText %>
                      </span>
                  </td>
                  <td class="px-6 py-4">
                    <% if (order.cod_amount> 0) { %>
                      <div class="font-bold text-emerald-400">฿<%= Number(order.cod_amount).toLocaleString() %>
                      </div>
                      <% } else { %>
                        <span class="text-slate-600">-</span>
                        <% } %>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-slate-300">
                      <%= order.created_at.toLocaleDateString('th-TH', { day: '2-digit' , month: 'short' }) %>
                    </div>
                    <div class="text-xs text-slate-500">
                      <%= order.created_at.toLocaleTimeString('th-TH', { hour: '2-digit' , minute: '2-digit' }) %>
                    </div>
                  </td>
                  <td class="px-6 py-4 text-center">
                    <a href="/orders/<%= order.id %>"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg transition-all border border-cyan-500/30">
                      <i class="fa-solid fa-eye"></i>
                      <span class="text-sm">ดูรายละเอียด</span>
                    </a>
                  </td>
                </tr>
                <% }) %>
                  <% } else { %>
                    <tr>
                      <td colspan="7" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center gap-4">
                          <i class="fa-solid fa-inbox text-5xl text-slate-700"></i>
                          <p class="text-slate-500">ไม่พบข้อมูลออเดอร์</p>
                        </div>
                      </td>
                    </tr>
                    <% } %>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
  // Chart Configuration
  Chart.defaults.font.family = "'Sarabun', 'Prompt', sans-serif";
  Chart.defaults.color = '#64748b';
  Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';

  const statsData = <% - JSON.stringify(charts.revenue30 || []) %>;
  const ctx = document.getElementById('statsChart');

  const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, 'rgba(6, 182, 212, 0.3)');
  gradient.addColorStop(1, 'rgba(6, 182, 212, 0)');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: statsData.map(i => i.d || i.date),
      datasets: [
        {
          label: 'จำนวนออเดอร์',
          data: statsData.map(i => i.count || i.orders || 0),
          backgroundColor: 'rgba(59, 130, 246, 0.6)',
          borderColor: '#3b82f6',
          borderWidth: 2,
          borderRadius: 8,
          order: 2
        },
        {
          label: 'รายได้ (บาท)',
          data: statsData.map(i => i.rev || i.revenue || 0),
          type: 'line',
          borderColor: '#06b6d4',
          backgroundColor: gradient,
          borderWidth: 3,
          tension: 0.4,
          fill: true,
          pointRadius: 4,
          pointHoverRadius: 8,
          pointBackgroundColor: '#06b6d4',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          order: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: '#e2e8f0',
            padding: 20,
            font: { size: 12, weight: 'bold' }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          titleColor: '#06b6d4',
          bodyColor: '#e2e8f0',
          borderColor: '#06b6d4',
          borderWidth: 1,
          padding: 12,
          displayColors: true,
          callbacks: {
            label: function (context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                if (context.datasetIndex === 1) {
                  label += '฿' + context.parsed.y.toLocaleString('th-TH');
                } else {
                  label += context.parsed.y.toLocaleString('th-TH');
                }
              }
              return label;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(255, 255, 255, 0.05)',
            borderDash: [5, 5]
          },
          ticks: {
            color: '#94a3b8',
            callback: function (value) {
              return value.toLocaleString('th-TH');
            }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            color: '#94a3b8'
          }
        }
      }
    }
  });

  // Filter Functionality
  const searchBox = document.getElementById('searchBox');
  const statusFilter = document.getElementById('statusFilter');
  const dateFilter = document.getElementById('dateFilter');
  const routeFilter = document.getElementById('routeFilter');

  function filterTable() {
    const searchTerm = searchBox.value.toLowerCase();
    const selectedStatus = statusFilter.value;
    const selectedRoute = routeFilter.value;

    const rows = document.querySelectorAll('.table-premium tbody tr');

    rows.forEach(row => {
      const jobNo = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
      const sender = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
      const statusText = row.querySelector('.status-badge')?.textContent.toLowerCase() || '';
      const route = row.querySelector('td:nth-child(1) .text-xs')?.textContent || '';

      const matchesSearch = jobNo.includes(searchTerm) || sender.includes(searchTerm);
      const matchesStatus = !selectedStatus || statusText.includes(selectedStatus);
      const matchesRoute = !selectedRoute || route.includes(selectedRoute);

      if (matchesSearch && matchesStatus && matchesRoute) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  searchBox?.addEventListener('input', filterTable);
  statusFilter?.addEventListener('change', filterTable);
  routeFilter?.addEventListener('change', filterTable);

  // Status Badge Filters
  document.querySelectorAll('.status-badge').forEach(badge => {
    badge.addEventListener('click', function () {
      const statusText = this.textContent.trim();
      // Map Thai status to filter value
      const statusMap = {
        'ใหม่': 'new',
        'รับของ': 'received',
        'ข้ามแดน': 'crossing',
        'ถึงคลัง': 'warehouse',
        'ออกส่ง': 'delivery',
        'สำเร็จ': 'completed'
      };

      const filterValue = statusMap[statusText] || '';
      statusFilter.value = filterValue;
      filterTable();

      // Visual feedback
      document.querySelectorAll('.status-badge').forEach(b => b.classList.remove('ring-2', 'ring-white'));
      this.classList.add('ring-2', 'ring-white');
    });
  });
</script>