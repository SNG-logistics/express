<div class="max-w-4xl mx-auto">
  <div class="flex items-center justify-between mb-8 animate-fade-in">
    <div>
      <h1 class="text-3xl font-black text-white tracking-tight flex items-center gap-3">
        <span class="bg-amber-500 w-1.5 h-8 rounded-full inline-block"></span>
        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
      </h1>
      <p class="text-slate-400 mt-1 ml-5">
        <a href="/orders" class="hover:text-amber-400 transition-colors">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</a>
        <i class="fa-solid fa-chevron-right text-[10px] mx-2 text-slate-600"></i>
        New Order
      </p>
    </div>
  </div>

  <% if (flash) { %>
    <div
      class="mb-6 p-4 rounded-xl bg-red-500/10 text-red-200 border border-red-500/20 flex items-center gap-3 animate-pulse-once">
      <i class="fa-solid fa-circle-exclamation"></i>
      <%= flash.message %>
    </div>
    <% } %>

      <div class="glass-panel-dark rounded-3xl overflow-hidden shadow-2xl border border-white/5 animate-fade-in"
        style="animation-delay: 0.1s;">
        <div class="p-6 border-b border-white/5 bg-black/20 flex items-center justify-between">
          <h3 class="font-bold text-white flex items-center gap-3">
            <span
              class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center text-amber-500 border border-amber-500/20">
              <i class="fa-solid fa-box-open"></i>
            </span>
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á
          </h3>
          <span class="text-xs text-slate-500 font-mono">Job No. Auto-Generated</span>
        </div>

        <form method="post" action="/orders" class="p-8 space-y-8" enctype="multipart/form-data">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">

          <!-- Section 1: Route & Customers -->
          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-6">
              <div class="pb-2 border-b border-white/5">
                <h4 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h4>
                <div class="space-y-5">
                  <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô (Job No)</label>
                    <input name="job_no"
                      class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-slate-400 font-mono focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition-all"
                      placeholder="Auto Generate" readonly>
                  </div>
                  <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏Ç‡∏ô‡∏™‡πà‡∏á <span
                        class="text-amber-500">*</span></label>
                    <div class="relative">
                      <select name="direction"
                        class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white appearance-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition-all cursor-pointer">
                        <option value="TH_TO_LA" class="bg-slate-900 text-white">üáπüá≠ ‡πÑ‡∏ó‡∏¢ ‡πÑ‡∏õ ‡∏•‡∏≤‡∏ß (TH ‚Üí LA)</option>
                        <option value="LA_TO_TH" class="bg-slate-900 text-white">üá±üá¶ ‡∏•‡∏≤‡∏ß ‡πÑ‡∏õ ‡πÑ‡∏ó‡∏¢ (LA ‚Üí TH)</option>
                      </select>
                      <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-500">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="space-y-6">
              <div class="pb-2">
                <h4 class="text-sm font-bold text-slate-300 uppercase tracking-wider mb-4">‡∏Ñ‡∏π‡πà‡∏Ñ‡πâ‡∏≤ (Partners)</h4>
                <div class="space-y-5">
                  <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (Sender)</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-dolly text-slate-500"></i>
                      </div>
                      <select name="sender_id"
                        class="w-full bg-slate-900/50 border border-white/10 rounded-xl pl-11 pr-10 py-3 text-white appearance-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition-all cursor-pointer">
                        <option value="" class="bg-slate-900">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á --</option>
                        <% customers.forEach(c=> { %>
                          <option value="<%= c.id %>" class="bg-slate-900">
                            <%= c.name %> (<%= c.type %>)
                          </option>
                          <% }) %>
                      </select>
                      <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-500">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                      </div>
                    </div>
                  </div>

                  <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (Receiver)</label>
                    <div class="relative">
                      <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-box text-slate-500"></i>
                      </div>
                      <select name="receiver_id"
                        class="w-full bg-slate-900/50 border border-white/10 rounded-xl pl-11 pr-10 py-3 text-white appearance-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 outline-none transition-all cursor-pointer">
                        <option value="" class="bg-slate-900">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö --</option>
                        <% customers.forEach(c=> { %>
                          <option value="<%= c.id %>" class="bg-slate-900">
                            <%= c.name %> (<%= c.type %>)
                          </option>
                          <% }) %>
                      </select>
                      <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-500">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section 2: Parcel Details -->
          <div class="p-6 rounded-2xl border border-white/5 bg-white/5">
            <h4 class="text-sm font-bold text-slate-300 mb-5 flex items-center gap-2">
              <i class="fa-solid fa-ruler-combined text-indigo-400"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏û‡∏±‡∏™‡∏î‡∏∏
            </h4>
            <div class="grid md:grid-cols-3 gap-6">
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</label>
                <div class="relative">
                  <select name="service_type"
                    class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white appearance-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all cursor-pointer">
                    <option value="general" class="bg-slate-900">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General)</option>
                    <option value="express" class="bg-slate-900">‡∏î‡πà‡∏ß‡∏ô (Express)</option>
                    <option value="frozen" class="bg-slate-900">‡πÅ‡∏ä‡πà‡πÄ‡∏¢‡πá‡∏ô/‡πÅ‡∏ä‡πà‡πÅ‡∏Ç‡πá‡∏á (Frozen)</option>
                  </select>
                  <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-500">
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                  </div>
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                <input name="declared_weight" type="number" step="0.01" placeholder="0.00"
                  class="w-full bg-slate-900/50 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡∏Ç‡∏ô‡∏≤‡∏î (cm)</label>
                <div class="grid grid-cols-3 gap-2">
                  <input name="width" id="input_width" type="number" placeholder="W"
                    class="bg-slate-900/50 border border-white/10 rounded-xl px-2 py-3 text-white text-center text-sm focus:border-indigo-500 outline-none">
                  <input name="length" id="input_length" type="number" placeholder="L"
                    class="bg-slate-900/50 border border-white/10 rounded-xl px-2 py-3 text-white text-center text-sm focus:border-indigo-500 outline-none">
                  <input name="height" id="input_height" type="number" placeholder="H"
                    class="bg-slate-900/50 border border-white/10 rounded-xl px-2 py-3 text-white text-center text-sm focus:border-indigo-500 outline-none">
                </div>
                <!-- Hidden legacy field for backward compatibility if needed, or we construct it -->
                <input type="hidden" name="declared_size" id="declared_size">
              </div>
            </div>
          </div>

          <!-- Section 3: Value & Costs -->
          <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-6 rounded-2xl border border-white/10">
            <div class="grid md:grid-cols-3 gap-6">
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Declared)</label>
                <div class="relative">
                  <span class="absolute left-4 top-3 text-slate-500">‡∏ø</span>
                  <input name="declared_value" type="number" step="0.01"
                    class="w-full bg-black/20 border border-white/10 rounded-xl pl-8 pr-4 py-3 text-white focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none transition-all"
                    placeholder="0.00">
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏™‡πà‡∏á (Cost)</label>
                <div class="relative">
                  <span class="absolute left-4 top-3 text-slate-500">‡∏ø</span>
                  <input name="price_amount" id="price_amount" type="number" step="0.01"
                    class="w-full bg-black/20 border border-white/10 rounded-xl pl-8 pr-4 py-3 text-white font-bold tracking-wide focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none transition-all"
                    placeholder="0.00">
                </div>
                <div class="mt-2 flex items-center gap-2">
                  <input type="checkbox" id="fix_price"
                    class="w-4 h-4 rounded border-slate-600 text-indigo-500 focus:ring-indigo-500 bg-slate-800 cursor-pointer">
                  <label for="fix_price" class="text-xs text-slate-400 cursor-pointer select-none">Fix Price
                    (‡∏ß‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î/‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å)</label>
                </div>
              </div>
              <div>
                <label class="text-xs font-bold text-slate-500 uppercase mb-1.5 block">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)</label>
                <div class="relative">
                  <span class="absolute left-4 top-3 text-emerald-500/50">‡∏ø</span>
                  <input name="cod_amount" type="number" step="0.01"
                    class="w-full bg-emerald-500/10 border border-emerald-500/20 rounded-xl pl-8 pr-4 py-3 text-emerald-400 font-bold tracking-wide focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none transition-all"
                    placeholder="0.00">
                </div>
              </div>
            </div>

            <!-- Section 4: Parcel Image -->
            <div class="p-6 rounded-2xl border border-white/5 bg-white/5">
              <h4 class="text-sm font-bold text-slate-300 mb-5 flex items-center gap-2">
                <i class="fa-solid fa-camera text-indigo-400"></i> ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏û‡∏±‡∏™‡∏î‡∏∏ (Parcel Image)
              </h4>
              <div class="space-y-4">
                <label class="block w-full group relative cursor-pointer">
                  <div
                    class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-slate-600 rounded-2xl bg-black/20 group-hover:bg-black/40 group-hover:border-indigo-500 transition-all overflow-hidden"
                    id="drop-zone">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6 text-slate-400"
                      id="upload-placeholder">
                      <i class="fa-solid fa-camera text-3xl mb-3 group-hover:text-indigo-500 transition-colors"></i>
                      <p class="mb-2 text-sm"><span class="font-bold text-indigo-400">Click to upload</span> or take a
                        photo</p>
                      <p class="text-xs text-slate-500">SVG, PNG, JPG (MAX. 5MB)</p>
                    </div>
                    <img id="image-preview" class="hidden w-full h-full object-contain" />
                  </div>
                  <input type="file" name="parcel_image" id="parcel_image" class="hidden" accept="image/*"
                    capture="environment" />
                </label>
              </div>
            </div>

            <div class="mt-6 flex items-center gap-3 p-4 rounded-xl bg-white/5 border border-white/5">
              <div class="flex items-center h-5">
                <input id="requires_customs" name="requires_customs" type="checkbox" value="1"
                  class="w-5 h-5 rounded border-slate-600 text-amber-500 focus:ring-amber-500 bg-slate-800 cursor-pointer">
              </div>
              <div class="ml-2">
                <label for="requires_customs"
                  class="font-bold text-sm text-slate-200 cursor-pointer">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏†‡∏≤‡∏©‡∏µ /
                  ‡∏ú‡πà‡∏≤‡∏ô‡∏û‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∏‡∏•‡∏Å‡∏≤‡∏Å‡∏£</label>
                <p class="text-slate-500 text-xs mt-0.5">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Customs Clearance ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©
                </p>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-end gap-3 pt-4 border-t border-white/10">
            <a href="/orders"
              class="px-6 py-3 rounded-xl text-slate-400 font-bold hover:bg-white/5 hover:text-white transition-all">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
            <button type="submit" class="cta-primary px-8 py-3 flex items-center gap-2">
              <i class="fa-solid fa-plus-circle"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
            </button>
          </div>
        </form>
      </div>

      <script>
        const shippingRates = <% - JSON.stringify(shippingRates || []) %>;

        document.addEventListener('DOMContentLoaded', () => {
          // Image Preview Logic
          const parcelImageInput = document.getElementById('parcel_image');
          const imagePreview = document.getElementById('image-preview');
          const uploadPlaceholder = document.getElementById('upload-placeholder');
          const dropZone = document.getElementById('drop-zone');

          if (parcelImageInput) {
            parcelImageInput.addEventListener('change', function (e) {
              const file = e.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                  imagePreview.src = e.target.result;
                  imagePreview.classList.remove('hidden');
                  uploadPlaceholder.classList.add('hidden');
                  dropZone.classList.add('border-indigo-500');
                }
                reader.readAsDataURL(file);
              }
            });
          }

          const fixPriceCheckbox = document.getElementById('fix_price');
          const priceInput = document.getElementById('price_amount');
          const weightInput = document.querySelector('input[name="declared_weight"]');
          const widthInput = document.getElementById('input_width');
          const lengthInput = document.getElementById('input_length');
          const heightInput = document.getElementById('input_height');

          function calculatePrice() {
            if (!fixPriceCheckbox.checked) return;

            const weight = parseFloat(weightInput.value) || 0;
            const w = parseFloat(widthInput.value) || 0;
            const l = parseFloat(lengthInput.value) || 0;
            const h = parseFloat(heightInput.value) || 0;
            const paramsDim = w + l + h; // As per requirement: Sum of W+L+H

            if (weight <= 0 && paramsDim <= 0) return;

            // Find best rate
            // Rates are already sorted by price ASC from backend
            const bestRate = shippingRates.find(rate =>
              rate.max_weight >= weight && rate.max_dimension >= paramsDim
            );

            if (bestRate) {
              priceInput.value = parseFloat(bestRate.price).toFixed(2);
              // Visual feedback
              priceInput.classList.add('bg-emerald-500/20');
              setTimeout(() => priceInput.classList.remove('bg-emerald-500/20'), 500);
            } else {
              // No matching rate found for this size/weight
              // Optional: could alert or just leave as is. behavior: leave as is.
              console.log('No matching rate found');
            }
          }

          const inputs = [fixPriceCheckbox, weightInput, widthInput, lengthInput, heightInput];
          inputs.forEach(el => {
            if (el) {
              el.addEventListener('input', calculatePrice);
              el.addEventListener('change', calculatePrice);
            }
          });
        });
      </script>
</div>